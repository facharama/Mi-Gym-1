{% extends "base_dash.html" %}
{% load static %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/migym-theme.css' %}">
  <style>
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .dashboard-container {
      animation: fadeInUp 0.6s ease-out;
    }

    .widget-card {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      height: 100%;
      border: none !important;
      background: var(--brand-panel);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--brand-border) !important;
    }

    .widget-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, rgba(6,182,212,0.03), transparent);
      opacity: 0;
      transition: opacity 0.4s;
    }

    .widget-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(6,182,212,0.15);
      border-color: var(--cyan, #06b6d4) !important;
    }

    .widget-card:hover::before {
      opacity: 1;
    }

    .widget-card.success-card {
      background: linear-gradient(145deg, var(--brand-panel), #0d1a0f);
      border-left: 5px solid #28a745 !important;
    }

    .widget-card.danger-card {
      background: linear-gradient(145deg, var(--brand-panel), #1a0d0f);
      border-left: 5px solid #dc3545 !important;
    }

    .widget-card.primary-card {
      background: linear-gradient(145deg, var(--brand-panel), #0d1419);
      border-left: 5px solid var(--cyan, #06b6d4) !important;
    }

    .widget-card.warning-card {
      background: linear-gradient(145deg, var(--brand-panel), #0d1419);
      border-left: 5px solid var(--cyan, #06b6d4) !important;
    }

    .widget-icon {
      font-size: 4rem;
      filter: drop-shadow(0 5px 15px rgba(6,182,212,0.2));
    }

    /* Removido - ya no se usa welcome-section */

    /* ========= OCUPACIÓN EN TIEMPO REAL - DESTACADO ========= */
    .ocupacion-widget-card {
      position: relative;
      overflow: hidden;
      background: linear-gradient(145deg, #0a0a0a, #141414) !important;
      border: 2px solid !important;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6) !important;
      animation: pulse-border 3s ease-in-out infinite;
    }

    @keyframes pulse-border {
      0%, 100% {
        box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 0 20px rgba(6,182,212,0.3);
      }
      50% {
        box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 0 40px rgba(6,182,212,0.5);
      }
    }

    .ocupacion-widget-card.ocupacion-low {
      border-color: #10b981 !important;
      background: linear-gradient(145deg, #0a0f0b, #0d1410) !important;
    }

    .ocupacion-widget-card.ocupacion-medium {
      border-color: #f59e0b !important;
      background: linear-gradient(145deg, #0f0d0a, #14110d) !important;
    }

    .ocupacion-widget-card.ocupacion-high {
      border-color: #ef4444 !important;
      background: linear-gradient(145deg, #0f0a0a, #140d0d) !important;
    }

    .ocupacion-widget-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 25px 60px rgba(0,0,0,0.8), 0 0 50px rgba(6,182,212,0.6) !important;
    }

    .ocupacion-badge {
      display: inline-block;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 1px;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
    }

    .ocupacion-badge i {
      animation: blink 1.5s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.3; }
    }

    .ocupacion-number-display {
      font-size: 3.5rem;
      font-weight: 900;
      line-height: 1;
      margin: 1.5rem 0;
    }

    .ocupacion-current {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 20px rgba(6,182,212,0.6));
      animation: glow-pulse 2s ease-in-out infinite;
    }

    @keyframes glow-pulse {
      0%, 100% {
        filter: drop-shadow(0 0 20px rgba(6,182,212,0.6));
      }
      50% {
        filter: drop-shadow(0 0 30px rgba(6,182,212,0.9));
      }
    }

    .ocupacion-separator {
      color: #4b5563;
      margin: 0 0.5rem;
    }

    .ocupacion-max {
      color: #6b7280;
      font-size: 2.5rem;
    }

    .ocupacion-meter-enhanced {
      height: 18px;
      background: rgba(255,255,255,0.05);
      border-radius: 25px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 300px;
    }

    .ocupacion-fill-enhanced {
      height: 100%;
      border-radius: 25px;
      position: relative;
      transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 0 20px currentColor;
    }

    .ocupacion-low .ocupacion-fill-enhanced {
      background: linear-gradient(90deg, #10b981, #059669);
      box-shadow: 0 0 20px #10b981;
    }

    .ocupacion-medium .ocupacion-fill-enhanced {
      background: linear-gradient(90deg, #f59e0b, #d97706);
      box-shadow: 0 0 20px #f59e0b;
    }

    .ocupacion-high .ocupacion-fill-enhanced {
      background: linear-gradient(90deg, #ef4444, #dc2626);
      box-shadow: 0 0 20px #ef4444;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .badge-status-green {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .badge-status-yellow {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .badge-status-red {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      animation: pulse 2s ease-in-out infinite;
    }

    .ocupacion-percentage {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--cyan, #06b6d4);
      margin-top: 1rem;
      margin-bottom: 0;
      text-shadow: 0 0 15px rgba(6,182,212,0.5);
    }

    .ocupacion-meter {
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      position: relative;
      border: 1px solid var(--brand-border);
    }

    .ocupacion-fill {
      height: 100%;
      transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .ocupacion-fill.success-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .ocupacion-fill.warning-fill {
      background: linear-gradient(90deg, #ffc107, #f59e0b);
    }

    .ocupacion-fill.danger-fill {
      background: linear-gradient(90deg, #dc3545, #c82333);
    }

    .card-stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cyan, #06b6d4) 0%, var(--brand-blue, #0891b2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .quick-summary-card {
      border-radius: 20px;
      border: 1px solid var(--brand-border);
      background: var(--brand-panel);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .quick-summary-card .card-header {
      background: linear-gradient(135deg, rgba(6,182,212,0.1) 0%, rgba(8,145,178,0.1) 100%);
      border-radius: 20px 20px 0 0;
      border: none;
      padding: 1.5rem;
      border-bottom: 1px solid rgba(6,182,212,0.2);
    }

    .ejercicio-mini-card {
      background: rgba(15,15,16,0.8);
      border-radius: 15px;
      padding: 1rem;
      border: 2px solid var(--brand-border);
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .ejercicio-mini-card:hover {
      border-color: var(--cyan, #06b6d4);
      transform: translateX(5px);
      box-shadow: 0 8px 25px rgba(6,182,212,0.2);
      background: rgba(6,182,212,0.05);
    }

    .badge-orden {
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyan, #06b6d4) 0%, #0891b2 100%);
      color: #0f172a;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 3px 10px rgba(6,182,212,0.3);
    }

    .stat-badge {
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .stat-badge.bg-success {
      background: linear-gradient(135deg, #28a745, #20c997) !important;
    }

    .stat-badge.bg-danger {
      background: linear-gradient(135deg, #dc3545, #c82333) !important;
    }

    .stat-badge.bg-secondary {
      background: linear-gradient(135deg, var(--brand-blue), #0891b2) !important;
      color: var(--brand-black) !important;
    }

    /* ============ RESPONSIVE DESIGN ============ */
    
    /* Tablets (992px - 768px) */
    @media (max-width: 992px) {
      .ocupacion-number-display {
        font-size: 3rem;
      }

      .ocupacion-current {
        font-size: 3rem;
      }

      .ocupacion-max {
        font-size: 2rem;
      }

      .card-stat-number {
        font-size: 2rem;
      }

      .widget-icon {
        font-size: 3rem;
      }

      .ocupacion-meter-enhanced {
        max-width: 250px;
      }
    }

    /* Tablets pequeñas (768px - 576px) */
    @media (max-width: 768px) {
      .dashboard-container {
        padding: 1rem !important;
      }

      .ocupacion-number-display {
        font-size: 2.5rem;
        margin: 1rem 0;
      }

      .ocupacion-current {
        font-size: 2.5rem;
      }

      .ocupacion-max {
        font-size: 1.8rem;
      }

      .ocupacion-separator {
        font-size: 1.8rem;
      }

      .widget-card {
        border-radius: 15px;
      }

      .card-stat-number {
        font-size: 1.8rem;
      }

      .widget-icon {
        font-size: 2.5rem;
      }

      .ocupacion-badge {
        font-size: 0.7rem;
        padding: 5px 12px;
      }

      .badge-status {
        font-size: 0.75rem;
        padding: 6px 15px;
      }

      .stat-badge {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
      }

      .ocupacion-percentage {
        font-size: 1.5rem;
      }

      .ocupacion-meter-enhanced {
        max-width: 100%;
        height: 15px;
      }

      .ejercicio-mini-card {
        padding: 0.8rem;
      }

      .badge-orden {
        width: 30px;
        height: 30px;
        font-size: 0.9rem;
      }

      .quick-summary-card .card-header {
        padding: 1rem;
      }
    }

    /* Móviles (576px - 400px) */
    @media (max-width: 576px) {
      .dashboard-container {
        padding: 0.5rem !important;
      }

      .row.g-4 {
        gap: 1rem !important;
      }

      .ocupacion-widget-card {
        border-radius: 12px;
      }

      .ocupacion-number-display {
        font-size: 2rem;
        margin: 0.8rem 0;
      }

      .ocupacion-current {
        font-size: 2rem;
      }

      .ocupacion-max {
        font-size: 1.5rem;
      }

      .ocupacion-separator {
        font-size: 1.5rem;
        margin: 0 0.3rem;
      }

      .widget-card {
        border-radius: 12px;
      }

      .widget-card .card-body {
        padding: 1.5rem !important;
      }

      .card-stat-number {
        font-size: 1.5rem;
      }

      .widget-icon {
        font-size: 2rem;
      }

      .ocupacion-badge {
        font-size: 0.65rem;
        padding: 4px 10px;
      }

      .badge-status {
        font-size: 0.7rem;
        padding: 5px 12px;
      }

      .stat-badge {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }

      .ocupacion-percentage {
        font-size: 1.3rem;
        margin-top: 0.8rem;
      }

      .ocupacion-meter-enhanced {
        height: 12px;
        max-width: 100%;
      }

      .ejercicio-mini-card {
        padding: 0.7rem;
        margin-bottom: 0.5rem;
      }

      .badge-orden {
        width: 28px;
        height: 28px;
        font-size: 0.85rem;
      }

      .quick-summary-card .card-header {
        padding: 0.8rem;
      }

      .quick-summary-card .card-header h5 {
        font-size: 1rem;
      }

      /* Ajustar columnas en móvil */
      .col-lg-4, .col-md-6 {
        width: 100%;
      }
    }

    /* Móviles muy pequeños (menos de 400px) */
    @media (max-width: 400px) {
      .ocupacion-number-display {
        font-size: 1.8rem;
      }

      .ocupacion-current {
        font-size: 1.8rem;
      }

      .ocupacion-max {
        font-size: 1.3rem;
      }

      .ocupacion-separator {
        font-size: 1.3rem;
      }

      .card-stat-number {
        font-size: 1.3rem;
      }

      .widget-icon {
        font-size: 1.8rem;
      }

      .widget-card .card-body {
        padding: 1rem !important;
      }

      .ocupacion-badge {
        font-size: 0.6rem;
        padding: 3px 8px;
      }

      .badge-status {
        font-size: 0.65rem;
        padding: 4px 10px;
      }

      .stat-badge {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }

      .ocupacion-meter-enhanced {
        height: 10px;
      }

      .ejercicio-mini-card {
        padding: 0.6rem;
      }

      .badge-orden {
        width: 25px;
        height: 25px;
        font-size: 0.75rem;
      }
    }
  </style>
{% endblock %}

{% block page_content %}
<div class="container-fluid py-4 dashboard-container">

  <!-- Welcome Banner: Socio en el Gym -->
  {% if esta_en_gym %}
  <div class="alert mb-4" role="alert" style="
    background: var(--brand-panel);
    border: 1px solid var(--brand-border);
    border-left: 4px solid var(--cyan, #06b6d4);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    animation: fadeInUp 0.6s ease-out;
  ">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="
        width: 8px;
        height: 8px;
        background: var(--cyan, #06b6d4);
        border-radius: 50%;
        box-shadow: 0 0 10px var(--cyan, #06b6d4);
      "></div>
      <div style="flex: 1;">
        <h6 class="mb-1" style="font-weight: 600; color: var(--text-primary, #e5e7eb); font-size: 1rem;">
          ¡Excelente! Estás entrenando en el gym
        </h6>
        <p class="mb-0" style="color: var(--text-secondary, #9ca3af); font-size: 0.875rem;">
          Tiempo de entrenamiento: <strong>{{ tiempo_entrenando }}</strong> · {{ socio.sucursal.nombre }}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Widgets Grid -->
  <div class="row g-4 mb-5">
    <!-- Widget: Estado de Cuota -->
    <div class="col-lg-4 col-md-6">
      <a href="{% url 'socios:mi_cuota' %}" class="text-decoration-none">
        <div class="card widget-card {% if suscripcion_vigente %}success-card{% else %}danger-card{% endif %}">
          <div class="card-body text-center p-4">
            <h5 class="card-title fw-bold mb-3">Mi Cuota</h5>
            {% if suscripcion_vigente %}
              <span class="stat-badge bg-success text-white d-inline-block mb-3">
                Al día
              </span>
              <p class="mb-1 fw-semibold">{{ suscripcion_vigente.plan.nombre }}</p>
              <p class="text-muted small mb-0">
                Vence: {{ suscripcion_vigente.fecha_fin|date:"d/m/Y" }}
              </p>
            {% else %}
              <span class="stat-badge bg-danger text-white d-inline-block mb-3">
                Inactiva
              </span>
              <p class="text-muted small mb-0">Contactá al administrador</p>
            {% endif %}
          </div>
        </div>
      </a>
    </div>

    <!-- Widget: Rutina del Día -->
    <div class="col-lg-4 col-md-6">
      <a href="{% url 'socios:mi_rutina' %}" class="text-decoration-none">
        <div class="card widget-card primary-card">
          <div class="card-body text-center p-4">
            <h5 class="card-title fw-bold mb-3">Rutina de Hoy</h5>
            {% if rutina_hoy %}
              <div class="card-stat-number mb-2">
                {{ rutina_hoy.detalles.count }}
              </div>
              <p class="mb-1 small text-muted">ejercicios programados</p>
              <p class="mb-0 fw-semibold">{{ asignacion_vigente.rutina.nombre }}</p>
            {% elif asignacion_vigente %}
              <span class="stat-badge bg-secondary text-white d-inline-block mb-2">
                Descanso
              </span>
              <p class="text-muted small mb-0">Sin ejercicios hoy</p>
            {% else %}
              <span class="stat-badge bg-secondary text-white d-inline-block mb-2">
                Sin asignar
              </span>
              <p class="text-muted small mb-0">Consultá al instructor</p>
            {% endif %}
          </div>
        </div>
      </a>
    </div>

    <!-- Widget: Ocupación DESTACADO -->
    <div class="col-lg-4 col-md-6">
      <a href="{% url 'socios:ocupacion_gimnasio' %}" class="text-decoration-none">
        <div class="card ocupacion-widget-card 
          {% if porcentaje_ocupacion < 40 %}ocupacion-low
          {% elif porcentaje_ocupacion < 70 %}ocupacion-medium
          {% else %}ocupacion-high{% endif %}">
          <div class="card-body text-center p-4 position-relative">
            <div class="ocupacion-badge mb-2">
              <i class="bi bi-broadcast"></i> EN VIVO
            </div>
            <h5 class="card-title fw-bold mb-4">Ocupación en Tiempo Real</h5>
            
            <!-- Número grande animado -->
            <div class="ocupacion-number-display mb-3">
              <span class="ocupacion-current">{{ ocupacion_actual }}</span>
              <span class="ocupacion-separator">/</span>
              <span class="ocupacion-max">{{ aforo_maximo }}</span>
            </div>
            
            <!-- Barra circular o barra horizontal mejorada -->
            <div class="ocupacion-meter-enhanced mx-auto mb-3">
              <div class="ocupacion-fill-enhanced" 
                style="width: {{ porcentaje_ocupacion }}%"
                data-width="{{ porcentaje_ocupacion }}">
              </div>
            </div>
            
            <div class="ocupacion-status-text mb-2">
              {% if porcentaje_ocupacion < 40 %}
                <span class="badge-status badge-status-green">
                  <i class="bi bi-check-circle-fill"></i> AFORO DISPONIBLE
                </span>
              {% elif porcentaje_ocupacion < 70 %}
                <span class="badge-status badge-status-yellow">
                  <i class="bi bi-exclamation-circle-fill"></i> OCUPACIÓN MODERADA
                </span>
              {% else %}
                <span class="badge-status badge-status-red">
                  <i class="bi bi-x-circle-fill"></i> AFORO ALTO
                </span>
              {% endif %}
            </div>
            
            <p class="ocupacion-percentage">{{ porcentaje_ocupacion }}%</p>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- Resumen rápido de rutina si hay -->
  {% if rutina_hoy and rutina_hoy.detalles.all %}
  <section class="quick-summary-card card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-white">
        Vista rápida de tu rutina de hoy
      </h5>
      <a href="{% url 'socios:mi_rutina' %}" class="btn btn-sm btn-light fw-semibold">Ver completa</a>
    </div>
    <div class="card-body p-4">
      <div class="row g-3">
        {% for detalle in rutina_hoy.detalles.all|slice:":6" %}
        <div class="col-lg-4 col-md-6">
          <div class="ejercicio-mini-card">
            <div class="d-flex align-items-center gap-3">
              <div class="badge-orden">
                {{ detalle.orden }}
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold mb-1">{{ detalle.ejercicio.nombre }}</div>
                <div class="text-muted small">
                  {% if detalle.series and detalle.repeticiones %}
                    {{ detalle.series }} x {{ detalle.repeticiones }} reps
                  {% elif detalle.tiempo_seg %}
                    {{ detalle.tiempo_seg }}s
                  {% else %}
                    Sin especificar
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% if rutina_hoy.detalles.count > 6 %}
      <div class="text-center mt-4">
        <span class="badge bg-light text-dark px-4 py-2">
          + {{ rutina_hoy.detalles.count|add:"-6" }} ejercicio{{ rutina_hoy.detalles.count|add:"-6"|pluralize }} más
        </span>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  // Aplicar ancho de ocupación dinámicamente para evitar errores de CSS parser
  document.addEventListener('DOMContentLoaded', function() {
    const ocupacionFill = document.querySelector('.ocupacion-fill[data-width]');
    if (ocupacionFill) {
      const width = ocupacionFill.getAttribute('data-width');
      ocupacionFill.style.width = width + '%';
    }
  });
</script>
{% endblock %}
