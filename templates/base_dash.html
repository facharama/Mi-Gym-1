{% extends "base.html" %}
{% load static %}

{% block navbar %}
  {% include "partials/nav_home.html" %}
{% endblock %}

{% block extra_css %}
  <style>
    /* Layout con sidebar */
    body {
      padding-top: 64px;
    }
    
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1040;
    }
    
    .sidebar-overlay.show {
      display: block;
    }
    
    /* Bot√≥n m√≥vil sidebar */
    .mobile-sidebar-btn {
      display: none;
      position: fixed;
      top: 12px;
      right: 15px;
      z-index: 1050;
      width: 45px;
      height: 45px;
      background: transparent;
      border: none;
      cursor: pointer;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }
    
    .mobile-sidebar-btn span {
      display: block;
      width: 28px;
      height: 3px;
      background: var(--migym-cyan);
      border-radius: 2px;
      transition: all 0.3s;
    }
    
    .mobile-sidebar-btn:hover span {
      background: white;
    }
    
    @media (max-width: 768px) {
      .mobile-sidebar-btn {
        display: flex;
      }
      
      .sidebar {
        position: fixed;
        left: -280px;
        width: 280px;
        z-index: 1045;
        transition: left 0.3s;
      }
      
      .sidebar.show {
        left: 0;
      }
    }
  </style>
{% endblock %}

{% block content %}
  {# Overlay para cerrar sidebar en m√≥viles #}
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  {# Bot√≥n flotante para abrir sidebar en m√≥vil #}
  <button id="mobile-sidebar-toggle" class="mobile-sidebar-btn" aria-label="Men√∫">
    <span></span>
    <span></span>
    <span></span>
  </button>

  {# Sidebar permanente a la izquierda - diferente seg√∫n el tipo de usuario #}
  {% if user.is_staff or user.is_superuser %}
    {% include "partials/sidebar_admin.html" %}
  {% else %}
    {% include "partials/sidebar_socio.html" %}
  {% endif %}


  {# Sumamos utilidades Bootstrap sin tocar tu layout #}
  <div class="dash-container container-fluid py-4">
    {% block page_content %}{% endblock %}
  </div>
  {% include "partials/_messages_modal.html" %}

{% endblock %}

{% block extra_js %}
  <!-- Script de confirmaci√≥n - PRIMERO -->
  <script src="{% static 'js/mg-confirm.js' %}"></script>

  {# === Estilos y scripts existentes === #}
  <script>document.documentElement.setAttribute('data-bs-theme','migym');</script>

  <script>
  /* === SIDEBAR: CONTROL SIMPLE Y FUNCIONAL === */
  
  document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;
    const sidebar = document.querySelector('.left-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const isMobile = () => window.innerWidth <= 768;
    
    // Limpiar localStorage antiguo
    localStorage.removeItem('sidebarCollapsed');
    
    // Funci√≥n para colapsar
    function collapseSidebar() {
      body.classList.add('sidebar-collapsed');
      console.log("‚û°Ô∏è Sidebar colapsado");
    }
    
    // Funci√≥n para expandir
    function expandSidebar() {
      body.classList.remove('sidebar-collapsed');
      console.log("‚¨ÖÔ∏è Sidebar expandido");
    }
    
    // Estado inicial: SIEMPRE colapsado
    collapseSidebar();
    
    // Buscar botones toggle
    const logo = document.querySelector('#sidebar-toggle') || document.querySelector('.brand-circle');
    const mobileBtn = document.getElementById('mobile-sidebar-toggle');
    
    // Funci√≥n toggle para usar en ambos botones
    function toggleSidebar(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const isCurrentlyCollapsed = body.classList.contains('sidebar-collapsed');
      console.log("üñ±Ô∏è Click en toggle - Estado actual:", isCurrentlyCollapsed ? "colapsado" : "expandido");
      
      if (isCurrentlyCollapsed) {
        expandSidebar();
      } else {
        collapseSidebar();
      }
    }
    
    // Conectar eventos
    if (logo) {
      logo.addEventListener("click", toggleSidebar);
    }
    
    if (mobileBtn) {
      mobileBtn.addEventListener("click", toggleSidebar);
      console.log("‚úÖ Bot√≥n m√≥vil conectado");
    }
    
    // Cerrar en m√≥vil al hacer click en overlay
    if (overlay) {
      overlay.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (isMobile()) {
          collapseSidebar();
        }
      });
    }
    
    // Cerrar en m√≥vil al hacer click fuera
    if (sidebar) {
      document.addEventListener('click', function(e) {
        const isCurrentlyExpanded = !body.classList.contains('sidebar-collapsed');
        if (isMobile() && isCurrentlyExpanded) {
          if (!sidebar.contains(e.target) && !logo.contains(e.target)) {
            collapseSidebar();
          }
        }
      });
      
      // Prevenir que clicks dentro cierren el sidebar
      sidebar.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
    
    // Cerrar al cambiar a m√≥vil
    window.addEventListener('resize', function() {
      const isCurrentlyExpanded = !body.classList.contains('sidebar-collapsed');
      if (isMobile() && isCurrentlyExpanded) {
        collapseSidebar();
      }
    });
    
    // Submen√∫s normales
    document.querySelectorAll(".ls-group-toggle").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const group = btn.parentElement;
        const wasOpen = group.classList.contains("open");
        
        // Cerrar todos los otros grupos
        document.querySelectorAll(".ls-group.open").forEach(g => {
          if(g !== group) g.classList.remove("open");
        });
        
        // Toggle el grupo actual
        group.classList.toggle("open");
        
        // Si se abri√≥ un grupo, expandir el sidebar
        if(!wasOpen && group.classList.contains("open")){
          body.classList.remove('sidebar-collapsed');
          sidebarExpandido = true;
          localStorage.setItem('sidebarCollapsed', 'false');
        }
      });
    });
    
    console.log("üéâ Control simple configurado");
  });
  
  // CSS para eliminar TODOS los hovers y transiciones
  const style = document.createElement('style');
  style.textContent = `
    .left-sidebar {
      transition: none !important;
      -webkit-transition: none !important;
    }
    .dash-container {
      transition: none !important;
      -webkit-transition: none !important;
    }
    
    /* Eliminar COMPLETAMENTE hover del sidebar */
    .left-sidebar:hover {
      width: 78px !important;
    }
    
    .sidebar-collapsed .left-sidebar:hover {
      width: 78px !important;
    }
    
    /* Forzar que siempre est√© colapsado a menos que se expanda manualmente */
    body.sidebar-collapsed .left-sidebar {
      width: 78px !important;
    }
    
    /* Eliminar cualquier clase hover */
    .sidebar-hover .left-sidebar {
      width: 78px !important;
    }
  `;
  document.head.appendChild(style);
  
  </script>

  <script>
  /* === Mini panel: selector de sucursal + ocupaci√≥n en vivo === */
  (function(){
    const OCC_URL = "{% url 'ocupacion:occupancy_current' %}";
    const sel    = document.getElementById('occ-sel');
    const elCnt  = document.getElementById('occ-count');
    const elCap  = document.getElementById('occ-capacity');
    const elBar  = document.getElementById('occ-bar');
    const elName = document.getElementById('occ-sucursal-name');
    if (!sel || !elCnt || !elCap || !elBar || !elName) return;

    function nombreSeleccionado(){
      return sel && sel.options.length ? sel.options[sel.selectedIndex].text.trim() : "";
    }

    async function refresh(){
      const suc = sel && sel.value ? sel.value : '';
      const url = suc ? `${OCC_URL}?sucursal_id=${encodeURIComponent(suc)}` : OCC_URL;

      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
        const data = await r.json();
        const count    = Number(data.count ?? 0);
        const capacity = Number(data.capacity ?? 0);
        const pct      = capacity > 0 ? Math.round((count / capacity) * 100) : 0;

        elCnt.textContent  = count;
        elCap.textContent  = capacity > 0 ? capacity : '‚Äî';
        elBar.style.width  = pct + '%';
        elName.textContent = nombreSeleccionado();

        if (window.miGymRefreshOcc) window.miGymRefreshOcc();
      }catch(e){ console.error(e); }
    }

    sel.addEventListener('change', refresh);
    refresh();
    setInterval(refresh, 5000);
  })();
  </script>

  {# === NUEVO: Bootstrap Datepicker con tema oscuro MiGym === #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

  <style>
    .datepicker {
      --bs-body-bg:#141414;
      --bs-body-color:#fff;
      --bs-border-color:#ff7a00;
      --bs-tertiary-bg:#1b1b1b;
      font-family: 'Inter', sans-serif;
    }
    .datepicker .datepicker-cell.selected,
    .datepicker .datepicker-cell.focused {
      background-color:#ff7a00;
      color:#fff;
    }
    .datepicker .datepicker-cell:hover {
      background:#2a2a2a;
    }
    .datepicker-dropdown {
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      border:1px solid #ff7a00;
      border-radius:8px;
    }
  </style>

  {{ block.super }}

  <script>
  // Loader robusto con fallback + init del datepicker
  (function(){
    function addCSS(href){
      var l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
      document.head.appendChild(l);
    }
    function addJS(src, onload){
      var s=document.createElement('script'); s.src=src; s.defer=true;
      s.onload=onload; s.onerror=function(){ onload && onload(new Error('load '+src)); };
      document.head.appendChild(s);
    }

    // Carga CSS primero (tema Bootstrap 5)
    addCSS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css');

    function initPickers(){
      if (!window.Datepicker) { return false; }
      var opts = { autohide:true, format:'dd/mm/yyyy', language:'es', container:document.body };
      document.querySelectorAll('input.datepicker').forEach(function(el){
        try{ if (el.type === 'date') el.type='text'; }catch(e){}
        var inst = window.Datepicker.getInstance(el);
        if (inst) { inst.setOptions(opts); }
        else { new window.Datepicker(el, opts); }
      });
      return true;
    }

    function ready(fn){
      if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn);
    }

    // 1er intento: jsdelivr
    addJS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
      ready(function(){
        if (initPickers()) return;
        // Fallback a unpkg si fall√≥ la 1ra URL
        addJS('https://unpkg.com/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
          ready(function(){ initPickers(); });
        });
      });
    });
  })();
  </script>
{% endblock %}


