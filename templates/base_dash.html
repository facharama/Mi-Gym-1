{% extends "base.html" %}
{% load static %}

{% block navbar %}
  {% include "partials/nav_home.html" %}
{% endblock %}

{% block extra_css %}
  {# Tus estilos existentes #}
  <link rel="stylesheet" href="{% static 'css/nav_home.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar_admin.css' %}">
{% endblock %}

{% block content %}
  {# Sidebar permanente a la izquierda #}
  {% include "partials/sidebar_admin.html" %}


  {# Sumamos utilidades Bootstrap sin tocar tu layout #}
  <div class="dash-container container-fluid py-4">
    {% block page_content %}{% endblock %}
  </div>
  {% include "partials/_messages_modal.html" %}

{% endblock %}

{% block extra_js %}

  {# === Estilos y scripts existentes === #}
  <script>document.documentElement.setAttribute('data-bs-theme','migym');</script>

  <script>
  /* === Sidebar: colapsar/expandir y submenús === */
  document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;
    const toggle = document.getElementById("sidebar-toggle");
    const groupToggles = document.querySelectorAll(".ls-group-toggle");
    body.classList.add("sidebar-collapsed");

    if (toggle) toggle.addEventListener("click", () => body.classList.toggle("sidebar-collapsed"));
    groupToggles.forEach(btn => btn.addEventListener("click", () => btn.parentElement.classList.toggle("open")));
  });
  </script>

  <script>
  /* === Mini panel: selector de sucursal + ocupación en vivo === */
  (function(){
    const OCC_URL = "{% url 'ocupacion:occupancy_current' %}";
    const sel    = document.getElementById('occ-sel');
    const elCnt  = document.getElementById('occ-count');
    const elCap  = document.getElementById('occ-capacity');
    const elBar  = document.getElementById('occ-bar');
    const elName = document.getElementById('occ-sucursal-name');
    if (!sel || !elCnt || !elCap || !elBar || !elName) return;

    function nombreSeleccionado(){
      return sel && sel.options.length ? sel.options[sel.selectedIndex].text.trim() : "";
    }

    async function refresh(){
      const suc = sel && sel.value ? sel.value : '';
      const url = suc ? `${OCC_URL}?sucursal_id=${encodeURIComponent(suc)}` : OCC_URL;

      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
        const data = await r.json();
        const count    = Number(data.count ?? 0);
        const capacity = Number(data.capacity ?? 0);
        const pct      = capacity > 0 ? Math.round((count / capacity) * 100) : 0;

        elCnt.textContent  = count;
        elCap.textContent  = capacity > 0 ? capacity : '—';
        elBar.style.width  = pct + '%';
        elName.textContent = nombreSeleccionado();

        if (window.miGymRefreshOcc) window.miGymRefreshOcc();
      }catch(e){ console.error(e); }
    }

    sel.addEventListener('change', refresh);
    refresh();
    setInterval(refresh, 5000);
  })();
  </script>

  {# === NUEVO: Bootstrap Datepicker con tema oscuro MiGym === #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

  <style>
    .datepicker {
      --bs-body-bg:#141414;
      --bs-body-color:#fff;
      --bs-border-color:#ff7a00;
      --bs-tertiary-bg:#1b1b1b;
      font-family: 'Inter', sans-serif;
    }
    .datepicker .datepicker-cell.selected,
    .datepicker .datepicker-cell.focused {
      background-color:#ff7a00;
      color:#fff;
    }
    .datepicker .datepicker-cell:hover {
      background:#2a2a2a;
    }
    .datepicker-dropdown {
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      border:1px solid #ff7a00;
      border-radius:8px;
    }
  </style>

  {{ block.super }}

  <script>
  // Loader robusto con fallback + init del datepicker
  (function(){
    function addCSS(href){
      var l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
      document.head.appendChild(l);
    }
    function addJS(src, onload){
      var s=document.createElement('script'); s.src=src; s.defer=true;
      s.onload=onload; s.onerror=function(){ onload && onload(new Error('load '+src)); };
      document.head.appendChild(s);
    }

    // Carga CSS primero (tema Bootstrap 5)
    addCSS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css');

    function initPickers(){
      if (!window.Datepicker) { return false; }
      var opts = { autohide:true, format:'dd/mm/yyyy', language:'es', container:document.body };
      document.querySelectorAll('input.datepicker').forEach(function(el){
        try{ if (el.type === 'date') el.type='text'; }catch(e){}
        var inst = window.Datepicker.getInstance(el);
        if (inst) { inst.setOptions(opts); }
        else { new window.Datepicker(el, opts); }
      });
      return true;
    }

    function ready(fn){
      if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn);
    }

    // 1er intento: jsdelivr
    addJS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
      ready(function(){
        if (initPickers()) return;
        // Fallback a unpkg si falló la 1ra URL
        addJS('https://unpkg.com/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
          ready(function(){ initPickers(); });
        });
      });
    });
  })();
  </script>
{% endblock %}


