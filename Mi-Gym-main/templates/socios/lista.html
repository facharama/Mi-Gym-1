{% extends "base_dash.html" %}
{% load static %}

{% block extra_css %}
  {{ block.super }}
  <!-- Bootstrap SOLO en esta vista -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'css/migym-theme.css' %}">
  <style>
    /* Estilos para tabla */
    .table {
      table-layout: auto;
      width: 100%;
      min-width: 800px; /* Ancho mínimo para que no se comprima */
    }
    
    .table td, .table th {
      padding: 0.5rem 0.75rem;
      vertical-align: middle;
      white-space: nowrap;
    }
    
    /* Columna de acciones sin límites */
    .table td:last-child,
    .table th:last-child {
      white-space: nowrap;
    }
    
    /* Alinear botones del formulario */
    .form-label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    /* Paginación responsive */
    .pagination {
      flex-wrap: wrap !important;
      margin: 0 !important;
    }
    
    .page-item {
      margin: 0.125rem !important;
    }
    
    .card-footer {
      overflow: visible !important;
    }

    /* Scrollbar personalizada */
    .container-fluid > div:last-child::-webkit-scrollbar {
      width: 8px;
    }
    
    .container-fluid > div:last-child::-webkit-scrollbar-track {
      background: #000;
    }
    
    .container-fluid > div:last-child::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }
    
    .container-fluid > div:last-child::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Responsive móvil */
    @media (max-width: 768px) {
      .container-fluid {
        margin-left: 0 !important;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
      
      /* Header más compacto en móvil */
      .container-fluid > div:first-child {
        padding: 0.5rem 0.5rem 0.25rem 0.5rem !important;
      }
      
      /* Tabla scrollable horizontal */
      .card {
        overflow-x: auto !important;
      }
      
      /* Formulario en columna en móvil */
      .form-control-sm,
      .form-select-sm {
        width: 100% !important;
        max-width: none !important;
      }
    }
  </style>
{% endblock %}

{% block page_content %}
<div class="container-fluid" style="min-height: calc(100vh - 109px); display: flex; flex-direction: column; padding: 0;">

  <!-- Header fijo (área roja) - SIN PADDING -->
  <div style="flex-shrink: 0; padding: 0.5rem 1rem 0.25rem 1rem;">
    <!-- Título y botón en una sola línea -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="h5 mb-0">Socios</h1>
      <a href="{% url 'socios:socios_crear' %}"
         class="btn-migym-primary"
         data-confirm="¿Crear un nuevo socio?"
         data-confirm-ok="Sí, crear"
         data-confirm-cancel="Cancelar">
        <i class="bi bi-plus-circle"></i>
        NUEVO SOCIO
      </a>
    </div>

    <!-- Formulario de búsqueda compacto -->
    <div class="card mb-2">
      <div class="card-body">
        <form method="get" action="" class="row g-2 align-items-center m-0">
          <div class="col-auto ps-0">
            <input id="f-ape" name="apellido" type="text"
                   value="{{ request.GET.apellido }}"
                   placeholder="Buscar apellido…"
                   class="form-control form-control-sm"
                   style="width: 200px;">
          </div>
          <div class="col-auto">
            <select id="f-estado" name="estado_activo" class="form-select form-select-sm" style="width: 120px;">
              <option value="">Todos</option>
              <option value="activos" {% if estado_filtro == 'activos' %}selected{% endif %}>Activos</option>
              <option value="inactivos" {% if estado_filtro == 'inactivos' %}selected{% endif %}>Inactivos</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn-migym-primary">
              <i class="bi bi-search"></i> Buscar
            </button>
          {% if request.GET.apellido or estado_filtro %}
            <a href="{% url 'socios:lista' %}" class="btn-migym-secondary">
              <i class="bi bi-x-circle"></i> Limpiar
            </a>
          {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Contenedor de tabla con scroll (área azul) -->
  <div style="padding: 0 1rem 0.5rem 1rem;">
    <div class="card">
      <div style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Apellido</th>
            <th>Nombre</th>
            <th>Sucursal</th>
            <th>Activo</th>
            <th class="text-end" style="width:220px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in socios %}
          <tr {% if not s.activo %}class="table-secondary"{% endif %}>
            <td>{{ s.user.username }}</td>
            <td>{{ s.user.last_name }}</td>
            <td>{{ s.user.first_name }}</td>
            <td>{{ s.sucursal }}</td>
            <td>
              {% if s.activo %}
                <span class="badge-migym success">Activo</span>
              {% else %}
                <span class="badge-migym danger">Inactivo</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group-migym" style="justify-content: flex-end;">
                <a class="btn-migym-ver" href="{% url 'socios:detalle' s.pk %}">
                  <i class="bi bi-eye"></i> Ver
                </a>

                {% if s.activo %}
                  <a class="btn-migym-editar" href="{% url 'socios:editar' s.pk %}">
                    <i class="bi bi-pencil"></i> Editar
                  </a>
                  <form method="post"
                        action="{% url 'socios:eliminar' s.pk %}"
                        class="d-inline"
                        onsubmit="return confirm('¿Desactivar al socio {{ s.user.get_full_name|default:s.user.username }}? Esta acción se puede revertir.')">
                    {% csrf_token %}
                    <button type="submit" class="btn-migym-eliminar">
                      <i class="bi bi-x-circle"></i> Desactivar
                    </button>
                  </form>
                {% else %}
                  <form method="post"
                        action="{% url 'socios:reactivar' s.pk %}"
                        class="d-inline"
                        onsubmit="return confirm('¿Reactivar al socio {{ s.user.get_full_name|default:s.user.username }}?')">
                    {% csrf_token %}
                    <button type="submit" class="btn-migym-primary" style="padding: 0.5rem 1rem !important; font-size: 0.875rem !important;">
                      <i class="bi bi-check-circle"></i> Reactivar
                    </button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-muted">No se encontraron socios.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

      <!-- Paginación -->
      {% if page_obj.has_other_pages %}
      <div class="card-footer d-none d-lg-flex flex-column" style="overflow: visible;">
        <nav aria-label="Paginación de socios">
          <ul class="pagination justify-content-center mb-2 flex-wrap" style="gap: 0.25rem;">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.apellido %}&apellido={{ request.GET.apellido }}{% endif %}{% if estado_filtro %}&estado_activo={{ estado_filtro }}{% endif %}">Primera</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.apellido %}&apellido={{ request.GET.apellido }}{% endif %}{% if estado_filtro %}&estado_activo={{ estado_filtro }}{% endif %}">Anterior</a>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.apellido %}&apellido={{ request.GET.apellido }}{% endif %}{% if estado_filtro %}&estado_activo={{ estado_filtro }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.apellido %}&apellido={{ request.GET.apellido }}{% endif %}{% if estado_filtro %}&estado_activo={{ estado_filtro }}{% endif %}">Siguiente</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.apellido %}&apellido={{ request.GET.apellido }}{% endif %}{% if estado_filtro %}&estado_activo={{ estado_filtro }}{% endif %}">Última</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        <p class="text-center text-muted small mb-0">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} | 
          Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} socios
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Bootstrap SOLO en esta vista -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
