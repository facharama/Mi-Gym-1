{% extends "base_dash.html" %}
{% load static %}

{% block extra_css %}
  {{ block.super }}
  <!-- Bootstrap SOLO en esta vista -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'css/migym-theme.css' %}">
{% endblock %}

{# Inject Django messages into JS array so our toast system can show them #}
{% if messages %}
<script>
window.__django_messages = [
{% for m in messages %}
  {message: "{{ m|escapejs }}", tags: "{{ m.tags }}"},
{% endfor %}
];
</script>
{% else %}
<script>window.__django_messages = [];</script>
{% endif %}

{% block page_content %}
<div class="container-fluid py-3">

  <!-- Header con título y acciones -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="h3 mb-2">Socio: {{ socio.user.get_full_name|default:socio.user.username }}</h1>
      <p class="text-body-secondary m-0">Detalle general y suscripciones.</p>
    </div>

    <!-- Botones de acción principales -->
    <div class="d-flex gap-2 flex-wrap justify-content-end">
      <!-- Registrar pago -->
      {% if has_active %}
        <button type="button" class="btn-migym-primary" disabled title="El socio ya tiene una suscripción vigente">
          <i class="bi bi-cash-coin"></i>
          REGISTRAR PAGO
        </button>
      {% else %}
        <button type="button" class="btn-migym-primary" data-bs-toggle="modal" data-bs-target="#modalRegistrarPago">
          <i class="bi bi-cash-coin"></i>
          REGISTRAR PAGO
        </button>
      {% endif %}

      <!-- Editar -->
      <a href="{% url 'socios:editar' socio.pk %}" class="btn-migym-editar">
        <i class="bi bi-pencil"></i>
        Editar
      </a>

      <!-- Eliminar -->
      <form method="post"
            action="{% url 'socios:eliminar' socio.pk %}"
            class="d-inline"
            data-confirm="¿Eliminar al socio {{ socio.user.get_full_name|default:socio.user.username }}? Esta acción no se puede deshacer."
            data-confirm-ok="Eliminar"
            data-confirm-cancel="Cancelar">
        {% csrf_token %}
        <button type="submit" class="btn-migym-eliminar">
          <i class="bi bi-trash"></i>
          Eliminar
        </button>
      </form>

      <!-- Volver -->
      <a href="{% url 'socios:lista' %}" class="btn-migym-secondary">
        <i class="bi bi-arrow-left"></i>
        Volver
      </a>
    </div>
  </div>

  <!-- Alerta si tiene suscripción vigente -->
  {% if has_active %}
  <div class="alert-migym info mb-3">
    <i class="bi bi-info-circle me-2"></i>
    El socio tiene una suscripción vigente.
  </div>
  {% endif %}

  <!-- Contenido principal en dos columnas -->
  <div class="row g-4">
    <!-- Columna izquierda: Datos del socio -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-4 pb-3" style="border-bottom: 1px solid var(--migym-border);">
            <i class="bi bi-person-circle me-2" style="color: var(--migym-cyan);"></i>
            Datos del socio
          </h2>
          
          <div class="row g-3">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Usuario</span>
                <span class="fw-semibold">{{ socio.user.username }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Nombre</span>
                <span class="fw-semibold">{{ socio.user.first_name }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Apellido</span>
                <span class="fw-semibold">{{ socio.user.last_name }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Email</span>
                <span class="fw-semibold">{{ socio.user.email }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Sucursal</span>
                <span class="fw-semibold">{{ socio.sucursal }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #222;">
                <span class="text-body-secondary">Estado</span>
                <span class="badge-migym success">{{ socio.estado }}</span>
              </div>
            </div>
            
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-2">
                <span class="text-body-secondary">Fecha de alta</span>
                <span class="fw-semibold">{{ socio.fecha_alta }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna derecha: Suscripciones -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-4 pb-3" style="border-bottom: 1px solid var(--migym-border);">
            <i class="bi bi-calendar-check me-2" style="color: var(--migym-orange);"></i>
            Suscripciones
          </h2>
          
          {% if suscripciones %}
            <div class="d-flex flex-column gap-3">
              {% for s in suscripciones %}
                <div class="p-3" style="border: 1px solid var(--migym-border); border-radius: 8px;">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <div class="fw-semibold mb-1" style="color: var(--migym-cyan);">{{ s.plan.nombre }}</div>
                      <div class="text-body-secondary small">
                        <i class="bi bi-calendar-range me-1"></i>
                        {{ s.fecha_inicio }} → {{ s.fecha_fin }}
                      </div>
                      <div class="text-body-secondary small mt-1">
                        <i class="bi bi-cash me-1"></i>
                        ${{ s.plan.precio|floatformat:2 }}
                      </div>
                    </div>
                    {% if s.estado == "Vigente" %}
                      <span class="badge-migym success">{{ s.estado }}</span>
                    {% elif s.estado == "Vencida" %}
                      <span class="badge-migym danger">{{ s.estado }}</span>
                    {% else %}
                      <span class="badge-migym info">{{ s.estado }}</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5 text-body-secondary">
              <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
              <p class="mt-3 mb-0">No tiene suscripciones registradas.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal: Registrar pago (crear suscripción rápida) -->
<div class="modal fade" id="modalRegistrarPago" tabindex="-1" aria-labelledby="modalRegistrarPagoLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'socios:suscripcion_rapida' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalRegistrarPagoLabel">Registrar pago - crear suscripción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="socio_id" value="{{ socio.pk }}">

          <div class="mb-3">
            <label for="id_plan_modal" class="form-label">Plan</label>
            <select id="id_plan_modal" name="plan_id" class="form-select" required>
              <option value="">-- Seleccioná un plan --</option>
              {% for p in planes %}
                <option value="{{ p.pk }}" data-price="{{ p.precio }}">{{ p.nombre }} ({{ p.precio }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="id_monto_modal_display" class="form-label">Monto (opcional)</label>
            <!-- Visible formatted field -->
            <input id="id_monto_modal_display" name="monto_display" type="text" class="form-control" placeholder="Dejar vacío para usar el precio del plan">
            <!-- Hidden real field submitted to server (normalized with dot) -->
            <input id="id_monto_modal" name="monto" type="hidden">
          </div>

          <div class="form-text">La suscripción se creará en estado "Pendiente" y luego deberás registrar el pago para activarla.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear y registrar pago</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Toast container -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index:2200"></div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {# Limpiar backdrops y estados residuales al cargar #}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Limpiar cualquier backdrop residual
    setTimeout(function(){
      var backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(function(bd){ bd.remove(); });
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    }, 100);
  });
  </script>

  {# === Post-save modal (2A): si venimos de crear con ?created=1 === #}
{% if request.GET.created == '1' %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  showOk('¡El usuario fue creado correctamente!', 'OK');

  function showOk(message, okText){
    // Backdrop
    var backdrop = document.createElement('div');
    backdrop.style.position = 'fixed';
    backdrop.style.inset = '0';
    backdrop.style.background = 'rgba(0,0,0,.6)';
    backdrop.style.display = 'flex';
    backdrop.style.alignItems = 'center';
    backdrop.style.justifyContent = 'center';
    backdrop.style.zIndex = '2050';

      // Card
    var card = document.createElement('div');
    card.style.width = 'min(520px,92vw)';
    card.style.background = '#0b0b0b';
    card.style.color = '#fff';
    card.style.border = '1px solid var(--orange, #ff9800)';
    card.style.borderRadius = '14px';
    card.style.boxShadow = '0 20px 60px rgba(0,0,0,.6)';
    card.setAttribute('role','dialog');
    card.setAttribute('aria-modal','true');

    // Head
    var head = document.createElement('div');
    head.style.padding = '.9rem 1rem';
    head.style.borderBottom = '1px solid rgba(255,255,255,.06)';
    head.style.fontWeight = '600';
    head.textContent = 'Aviso';

    // Body
    var body = document.createElement('div');
    body.style.padding = '1rem';
    body.textContent = message || 'Operación realizada.';

    // Foot
    var foot = document.createElement('div');
    foot.style.display = 'flex';
    foot.style.justifyContent = 'flex-end';
    foot.style.gap = '.5rem';
    foot.style.padding = '.9rem 1rem';
    foot.style.borderTop = '1px solid rgba(255,255,255,.06)';

    var ok = document.createElement('button');
    ok.textContent = okText || 'OK';
    ok.style.border = '1px solid #ff9800';
    ok.style.background = '#ff9800';
    ok.style.color = '#fff';
    ok.style.padding = '.55rem .95rem';
    ok.style.borderRadius = '10px';
    ok.style.cursor = 'pointer';

    ok.addEventListener('click', function(){
      try {
        document.body.removeChild(backdrop);
      } catch(e){}
      // Limpiar cualquier backdrop residual de Bootstrap
      setTimeout(function(){
        var backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(function(bd){ bd.remove(); });
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }, 50);
    });

    // También permitir cerrar haciendo clic fuera del card
    backdrop.addEventListener('click', function(e){
      if(e.target === backdrop){
        ok.click();
      }
    });

    foot.appendChild(ok);
    card.appendChild(head);
    card.appendChild(body);
    card.appendChild(foot);
    backdrop.appendChild(card);
    document.body.appendChild(backdrop);
    ok.focus();
 }
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Validación cliente para el modal 'Registrar pago'
  var modal = document.getElementById('modalRegistrarPago');
  if (!modal) return;

  var form = modal.querySelector('form');
  var select = modal.querySelector('select[name="plan_id"]');
  var montoInput = modal.querySelector('input[name="monto"]');
  var submitBtn = modal.querySelector('button[type="submit"]');

  // Seguridad: si no hay select o submit, no hacemos nada
  if (!form || !select || !submitBtn) return;

  // Deshabilitar submit hasta que se seleccione un plan
  function updateSubmitState() {
    if (select.value && select.value.trim() !== '') {
      submitBtn.removeAttribute('disabled');
    } else {
      submitBtn.setAttribute('disabled', 'disabled');
    }
  }

  updateSubmitState();

  select.addEventListener('change', updateSubmitState);

  // Auto-completar monto con el precio del plan seleccionado (si el campo está vacío o se autofilló antes)
  // Monto: usamos display input + hidden normalizado
  var montoDisplay = modal.querySelector('#id_monto_modal_display');
  var montoHidden = modal.querySelector('#id_monto_modal');

  function formatES(value) {
    try {
      var n = Number(String(value).replace(/,/g, '.'));
      if (isNaN(n)) return '';
      return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    } catch (e) { return value; }
  }

  function normalizeNumberString(str) {
    if (!str) return '';
    var s = String(str).trim();
    // remove spaces
    s = s.replace(/\s/g, '');
    // remove thousands separators (.) and replace comma with dot
    s = s.replace(/\./g, '');
    s = s.replace(/,/g, '.');
    // keep only digits, dot and minus
    s = s.replace(/[^0-9.\-]/g, '');
    return s;
  }

  function updateMontoFromPlan() {
    var opt = select.options[select.selectedIndex];
    var price = opt ? opt.dataset.price : null;
    var currentlyAuto = montoDisplay && montoDisplay.dataset.auto === 'true';
    if (price && montoDisplay && (montoDisplay.value === '' || currentlyAuto)) {
      montoDisplay.value = formatES(price);
      montoDisplay.dataset.auto = 'true';
      if (montoHidden) montoHidden.value = normalizeNumberString(price);
    }
  }

  select.addEventListener('change', updateMontoFromPlan);

  if (montoDisplay) {
    montoDisplay.addEventListener('input', function () {
      montoDisplay.dataset.auto = 'false';
      if (montoHidden) montoHidden.value = normalizeNumberString(montoDisplay.value);
    });
  }

  form.addEventListener('submit', function (ev) {
    if (!select.value || select.value.trim() === '') {
      ev.preventDefault();
      ev.stopPropagation();
      // Mostrar toast de advertencia
      showToast('Por favor seleccioná un plan antes de continuar.', 'warning');
      return false;
    }
    // si hay campo display y hidden, aseguremos que hidden contenga valor normalizado
    if (montoHidden && montoDisplay) {
      if (!montoHidden.value && montoDisplay.value) {
        montoHidden.value = normalizeNumberString(montoDisplay.value);
      }
    }
  });

  // Mostrar mensajes de Django (si los hubiere) como toasts
  if (window.__django_messages && Array.isArray(window.__django_messages)) {
    window.__django_messages.forEach(function(m){
      showToast(m.message, m.tags || 'info');
    });
  }

  // showToast helper: crea un toast Bootstrap
  function showToast(message, kind) {
    try {
      var container = document.getElementById('toast-container');
      if (!container) return alert(message);

      var toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center text-bg-dark border-0';
      toastEl.setAttribute('role', 'status');
      toastEl.setAttribute('aria-live', 'polite');
      toastEl.setAttribute('aria-atomic', 'true');

      var toastBody = document.createElement('div');
      toastBody.className = 'd-flex';
      var content = document.createElement('div');
      content.className = 'toast-body';
      content.textContent = message;

      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn-close btn-close-white me-2 m-auto';
      btn.setAttribute('data-bs-dismiss', 'toast');
      btn.setAttribute('aria-label', 'Cerrar');

      toastBody.appendChild(content);
      toastBody.appendChild(btn);
      toastEl.appendChild(toastBody);
      container.appendChild(toastEl);

      var t = new bootstrap.Toast(toastEl, { delay: 5000 });
      t.show();
    } catch (e) {
      console.error(e);
      alert(message);
    }
  }
});
</script>
{% endblock %}
