{% extends "base.html" %}
{% load static %}

{% block navbar %}
  {% include "partials/nav_home.html" %}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/nav_home.css' %}?v=20251111a">
  <link rel="stylesheet" href="{% static 'css/sidebar_admin.css' %}?v=20251111c">
  <link rel="stylesheet" href="{% static 'css/forms-migym.css' %}?v=20251111e">
  <style>
    /* Compensar navbar fijo */
    body {
      padding-top: 64px !important;
    }
    
    /* Botón móvil sidebar */
    .mobile-sidebar-btn {
      display: none;
      position: fixed;
      top: 12px;
      left: 15px;
      z-index: 1051;
      width: 45px;
      height: 45px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--migym-cyan);
      border-radius: 8px;
      cursor: pointer;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }
    
    .mobile-sidebar-btn span {
      display: block;
      width: 28px;
      height: 3px;
      background: var(--migym-cyan);
      border-radius: 2px;
      transition: all 0.3s;
    }
    
    .mobile-sidebar-btn:hover span {
      background: white;
    }
    
    @media (max-width: 768px) {
      .mobile-sidebar-btn {
        display: flex;
      }
      
      .sidebar {
        position: fixed;
        left: -280px;
        width: 280px;
        z-index: 1045;
        transition: left 0.3s;
      }
      
      .sidebar.show {
        left: 0;
      }
    }
  </style>
{% endblock %}

{% block content %}
  {# Overlay para cerrar sidebar en móviles #}
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  {# Botón flotante para abrir sidebar en móvil #}
  <button id="mobile-sidebar-toggle" class="mobile-sidebar-btn" aria-label="Menú">
    <span></span>
    <span></span>
    <span></span>
  </button>

  {# Sidebar permanente a la izquierda - diferente según el tipo de usuario #}
  {% if user.is_staff or user.is_superuser %}
    {% include "partials/sidebar_admin.html" %}
  {% else %}
    {% include "partials/sidebar_socio.html" %}
  {% endif %}


  {# Sumamos utilidades Bootstrap sin tocar tu layout #}
  <div class="dash-container container-fluid py-4">
    {% block page_content %}{% endblock %}
  </div>
  {% include "partials/_messages_modal.html" %}

{% endblock %}

{% block extra_js %}
  <!-- Script de confirmación - PRIMERO -->
  <script src="{% static 'js/mg-confirm.js' %}"></script>

  {# === Estilos y scripts existentes === #}
  <script>document.documentElement.setAttribute('data-bs-theme','migym');</script>

  <script>
  /* === SIDEBAR: CONTROL SIMPLE === */
  document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;
    const sidebar = document.querySelector('.left-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const logo = document.querySelector('.brand-circle');
    const mobileBtn = document.getElementById('mobile-sidebar-toggle');
    
    // Agregar clase para ocultar botón del navbar en móvil
    body.classList.add('has-sidebar');
    
    // Función para saber si es móvil
    const isMobile = () => window.innerWidth <= 768;
    
    // Estado inicial: colapsado en móvil, expandido en desktop
    if (isMobile()) {
      body.classList.add('sidebar-collapsed');
    } else {
      body.classList.remove('sidebar-collapsed');
    }
    
    // Toggle del sidebar
    function toggleSidebar(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      body.classList.toggle('sidebar-collapsed');
    }
    
    // Click en logo
    if (logo) {
      logo.addEventListener("click", toggleSidebar);
      logo.style.cursor = 'pointer';
    }
    
    // Click en botón móvil
    if (mobileBtn) {
      mobileBtn.addEventListener("click", toggleSidebar);
    }
    
    // Click en overlay (cerrar en móvil)
    if (overlay) {
      overlay.addEventListener('click', function(e) {
        e.preventDefault();
        if (isMobile() && !body.classList.contains('sidebar-collapsed')) {
          body.classList.add('sidebar-collapsed');
        }
      });
    }
    
    // Cerrar al hacer click fuera en móvil
    if (sidebar) {
      document.addEventListener('click', function(e) {
        if (isMobile() && !body.classList.contains('sidebar-collapsed')) {
          if (!sidebar.contains(e.target) && e.target !== logo && e.target !== mobileBtn) {
            body.classList.add('sidebar-collapsed');
          }
        }
      });
    }
    
    // Ajustar en resize
    window.addEventListener('resize', function() {
      if (isMobile() && !body.classList.contains('sidebar-collapsed')) {
        body.classList.add('sidebar-collapsed');
      }
    });
    
    // Submenús
    document.querySelectorAll(".ls-group-toggle").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const group = btn.parentElement;
        
        // Cerrar otros
        document.querySelectorAll(".ls-group.open").forEach(g => {
          if(g !== group) g.classList.remove("open");
        });
        
        // Toggle actual
        group.classList.toggle("open");
        
        // Expandir sidebar si se abre un grupo
        if (group.classList.contains("open")) {
          body.classList.remove('sidebar-collapsed');
        }
      });
    });
    
    // Cerrar sidebar al hacer clic en cualquier enlace
    if (sidebar) {
      // Capturar TODOS los enlaces dentro del sidebar
      sidebar.addEventListener('click', function(e) {
        // Verificar si el click fue en un enlace <a> (no en botones de toggle)
        const clickedLink = e.target.closest('a');
        
        if (clickedLink) {
          // Es un enlace, cerrar sidebar en móvil
          if (isMobile()) {
            // Pequeño delay para que la navegación se procese primero
            setTimeout(() => {
              body.classList.add('sidebar-collapsed');
            }, 150);
          }
        }
      }, true); // useCapture = true para capturar antes que otros eventos
    }
  });
  </script>

  <script>
  /* === Mini panel: selector de sucursal + ocupación en vivo === */
  (function(){
    const OCC_URL = "{% url 'ocupacion:occupancy_current' %}";
    const sel    = document.getElementById('occ-sel');
    const elCnt  = document.getElementById('occ-count');
    const elCap  = document.getElementById('occ-capacity');
    const elBar  = document.getElementById('occ-bar');
    const elName = document.getElementById('occ-sucursal-name');
    if (!sel || !elCnt || !elCap || !elBar || !elName) return;

    function nombreSeleccionado(){
      return sel && sel.options.length ? sel.options[sel.selectedIndex].text.trim() : "";
    }

    async function refresh(){
      const suc = sel && sel.value ? sel.value : '';
      const url = suc ? `${OCC_URL}?sucursal_id=${encodeURIComponent(suc)}` : OCC_URL;

      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
        const data = await r.json();
        const count    = Number(data.count ?? 0);
        const capacity = Number(data.capacity ?? 0);
        const pct      = capacity > 0 ? Math.round((count / capacity) * 100) : 0;

        elCnt.textContent  = count;
        elCap.textContent  = capacity > 0 ? capacity : '—';
        elBar.style.width  = pct + '%';
        elName.textContent = nombreSeleccionado();

        if (window.miGymRefreshOcc) window.miGymRefreshOcc();
      }catch(e){ console.error(e); }
    }

    sel.addEventListener('change', refresh);
    refresh();
    setInterval(refresh, 5000);
  })();
  </script>

  {# === NUEVO: Bootstrap Datepicker con tema oscuro MiGym === #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

  <style>
    .datepicker {
      --bs-body-bg:#141414;
      --bs-body-color:#fff;
      --bs-border-color:#ff7a00;
      --bs-tertiary-bg:#1b1b1b;
      font-family: 'Inter', sans-serif;
    }
    .datepicker .datepicker-cell.selected,
    .datepicker .datepicker-cell.focused {
      background-color:#ff7a00;
      color:#fff;
    }
    .datepicker .datepicker-cell:hover {
      background:#2a2a2a;
    }
    .datepicker-dropdown {
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      border:1px solid #ff7a00;
      border-radius:8px;
    }
  </style>

  {{ block.super }}

  <script>
  // Loader robusto con fallback + init del datepicker
  (function(){
    function addCSS(href){
      var l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
      document.head.appendChild(l);
    }
    function addJS(src, onload){
      var s=document.createElement('script'); s.src=src; s.defer=true;
      s.onload=onload; s.onerror=function(){ onload && onload(new Error('load '+src)); };
      document.head.appendChild(s);
    }

    // Carga CSS primero (tema Bootstrap 5)
    addCSS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css');

    function initPickers(){
      if (!window.Datepicker) { return false; }
      var opts = { autohide:true, format:'dd/mm/yyyy', language:'es', container:document.body };
      document.querySelectorAll('input.datepicker').forEach(function(el){
        try{ if (el.type === 'date') el.type='text'; }catch(e){}
        var inst = window.Datepicker.getInstance(el);
        if (inst) { inst.setOptions(opts); }
        else { new window.Datepicker(el, opts); }
      });
      return true;
    }

    function ready(fn){
      if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn);
    }

    // 1er intento: jsdelivr
    addJS('https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
      ready(function(){
        if (initPickers()) return;
        // Fallback a unpkg si falló la 1ra URL
        addJS('https://unpkg.com/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js', function(){
          ready(function(){ initPickers(); });
        });
      });
    });
  })();
  </script>
{% endblock %}


