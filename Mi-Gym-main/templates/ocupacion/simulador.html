<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MiGym Â· Simulador de Accesos</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  :root{
    --bg:#0b0f19; --panel:#0f172a; --card:#111827; --muted:#9aa4ad;
    --text:#e5e7eb; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --radius:18px; --shadow:0 20px 60px rgba(2,6,23,.55);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial; background:radial-gradient(1200px 600px at 10% -10%, #10203a 0, #0b0f19 45%); color:var(--text)}
  header{padding:24px 28px; display:flex; align-items:center; gap:16px; border-bottom:1px solid #0b1220; background:linear-gradient(180deg,#0b1220,transparent)}
  header h1{margin:0; font-size:20px; letter-spacing:.5px}
  .badge{padding:6px 10px; border-radius:999px; background:rgba(34,211,238,.12); color:#67e8f9; border:1px solid rgba(34,211,238,.3); font-size:12px}
  .wrap{max-width:980px; margin:30px auto; padding:0 20px; display:grid; gap:22px; grid-template-columns: 1.1fr .9fr}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
  .card h2{margin:0; padding:18px 20px; border-bottom:1px solid rgba(255,255,255,.08); font-size:18px}
  .card .content{padding:20px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input, select{
    width:100%; background:#0c1324; color:var(--text); border:1px solid rgba(255,255,255,.08);
    padding:12px 12px; border-radius:12px; outline:none
  }
  .row{display:grid; gap:14px; grid-template-columns:1fr 1fr}
  .btns{display:flex; gap:10px; margin-top:12px}
  button{
    appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer;
    background:linear-gradient(135deg,#06b6d4,#22d3ee); color:#001018
  }
  button.secondary{background:#121a2e; color:#cbd5e1; border:1px solid rgba(255,255,255,.08)}
  .status{margin-top:14px; font-size:14px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
  .meter{
    height:20px; background:#0c1324; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden
  }
  .bar{height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#22d3ee)}
  .kpis{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:12px}
  .kpi{background:#0c1324; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px}
  .kpi b{font-size:24px}
  .hint{font-size:12px; color:var(--muted); margin-top:8px}
  footer{padding:18px 28px; color:var(--muted); font-size:12px; text-align:center; opacity:.8}
</style>
</head>
<body>
  <header>
    <span class="badge">Demo</span>
    <h1>MiGym Registro Â· Simulador de Entradas/Salidas</h1>
    <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
      <button onclick="copiarRutaQR()" 
         style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
        <i class="bi bi-qr-code-scan"></i> <span id="btn-text">Copiar Ruta Simulador QR</span>
      </button>
      <span id="msg-copiado" style="color: #22c55e; font-size: 0.85rem; display: none;">
        âœ“ Ruta copiada! PÃ©gala en el navegador
      </span>
    </div>
  </header>

  <div class="wrap">
    <!-- Panel de acciÃ³n -->
    <section class="card">
      <h2>Registrar movimiento</h2>
      <div class="content">
        <div class="row">
          <div>
            <label for="member">DNI o Usuario</label>
            <input id="member" placeholder="Ej: 40123123 o juanperez" autocomplete="off">

          </div>
          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo">
              <option value="IN">Entrada (IN)</option>
              <option value="OUT">Salida (OUT)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div>
            <label for="source">Fuente</label>
            <select id="source">
              <option>RFID</option>
              <option>QR</option>
              <option>TURNSTILE</option>
              <option>KIOSK</option>
            </select>
          </div>
          <div>
            <label for="device">Dispositivo</label>
            <input id="device" value="kiosk-demo-1">
          </div>
        </div>

        <div class="btns">
          <button id="btnRegistrar">Registrar</button>
          <button class="secondary" id="btnEntradaRapida">Entrada rÃ¡pida</button>
          <button class="secondary" id="btnSalidaRapida">Salida rÃ¡pida</button>
        </div>

        <div id="status" class="status"></div>
        <div class="hint">Tip: usÃ¡ un socio real (cÃ³digo existente). Si tu API requiere token de dispositivo, agregalo en el header dentro del script.</div>
      </div>
    </section>

    <!-- Panel de ocupaciÃ³n -->
    <section class="card">
      <h2>OcupaciÃ³n actual</h2>
      <div class="content">
        <div class="meter"><div id="bar" class="bar"></div></div>
        <div class="kpis">
          <div class="kpi"><div>Personas dentro</div><b id="count">0</b></div>
          <div class="kpi"><div>Capacidad</div><b id="capacity">100</b></div>
        </div>
        <div class="hint">Se refresca cada 5 segundos.</div>
      </div>
    </section>
  </div>

  <footer>Â© MiGym Registro â€” SimulaciÃ³n de accesos para demostraciÃ³n</footer>

<script>
  // ðŸ‘‰ AjustÃ¡ estas rutas si tu API es distinta:
  const API_URL = "/ocupacion/api/access/";
  const OCC_URL = "/ocupacion/api/occupancy/current/";
     // GET count
  const CAPACITY = 100; // Si tenÃ©s capacidad por sede, traela del back. Para la demo lo dejamos fijo.

  document.getElementById("capacity").textContent = CAPACITY;

  const $m = id => document.getElementById(id);
  const showStatus = (msg, cls="") => {
    const el = $m("status"); el.className = "status " + cls; el.textContent = msg;
  };

  async function registrar(tipo) {
    const member = $m("member").value.trim();
    const source = $m("source").value.trim();
    const device = $m("device").value.trim() || "kiosk-demo-1";
    if (!member) {
      showStatus("IngresÃ¡ un cÃ³digo de socio / UID.", "warn");
      return;
    }
    try {
      // Si tu endpoint requiere token de dispositivo, agregalo acÃ¡:
      // headers["X-Device-Token"] = "secret-token-123";
      const headers = { "Content-Type": "application/json" };
      const body = JSON.stringify({
        member_code: member,
        type: tipo,
        source: source,
        device_id: device,
        raw_uid: member
      });
      const r = await fetch(API_URL, { method: "POST", headers, body });
      const data = await r.json().catch(()=> ({}));
      if (r.ok) {
        showStatus(`âœ… ${tipo === "IN" ? "Entrada" : "Salida"} registrada`, "ok");
        await refreshOcupacion();
      } else {
        // Mostrar mensajes de error mÃ¡s descriptivos
        if (data.status === "error" && data.message) {
          showStatus(`âŒ ${data.message}: ${data.detail || ''}`, "err");
        } else {
          showStatus(`âš ï¸ ${data.detail || data.message || data.status || "Error en la solicitud"}`, "warn");
        }
      }
    } catch (e) {
      showStatus("âŒ No se pudo conectar con el backend", "err");
      console.error(e);
    }
  }

  async function refreshOcupacion(){
    try{
      const r = await fetch(OCC_URL);
      const { count } = await r.json();
      $m("count").textContent = count ?? 0;
      const pct = Math.max(0, Math.min(100, Math.round((count / CAPACITY) * 100)));
      $m("bar").style.width = pct + "%";
    }catch(e){
      console.error(e);
    }
  }

  // Eventos UI
  $m("btnRegistrar").addEventListener("click", () => {
    const tipo = $m("tipo").value;
    registrar(tipo);
  });
  $m("btnEntradaRapida").addEventListener("click", () => {
    $m("tipo").value = "IN"; registrar("IN");
  });
  $m("btnSalidaRapida").addEventListener("click", () => {
    $m("tipo").value = "OUT"; registrar("OUT");
  });

  // Polling cada 5s
  refreshOcupacion();
  setInterval(refreshOcupacion, 5000);

  // Copiar ruta del simulador QR
  function copiarRutaQR() {
    const ruta = "file:///C:/Users/Usuario/Desktop/2025/migym_ultimo/Mi-Gym/tools/simulador_qr.html";
    navigator.clipboard.writeText(ruta).then(() => {
      const msg = document.getElementById('msg-copiado');
      const btn = document.getElementById('btn-text');
      msg.style.display = 'inline';
      btn.textContent = 'Â¡Copiado!';
      setTimeout(() => {
        msg.style.display = 'none';
        btn.textContent = 'Copiar Ruta Simulador QR';
      }, 3000);
    }).catch(err => {
      alert('Ruta: file:///C:/Users/Usuario/Desktop/2025/migym_ultimo/Mi-Gym/tools/simulador_qr.html');
    });
  }
</script>
</body>
</html>
